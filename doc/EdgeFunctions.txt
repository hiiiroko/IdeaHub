// delete-storage-files

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'

serve(async (req) => {
  try {
    const SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    const SUPABASE_URL = Deno.env.get('SUPABASE_URL')

    if (!SERVICE_ROLE_KEY || !SUPABASE_URL) {
      return new Response('Missing Supabase Service Role Key or URL', { status: 500 })
    }

    const supabaseAdmin = createClient(SUPABASE_URL, SERVICE_ROLE_KEY)

    const data = await req.json()
    const { video_path, cover_path } = data.record

    if (!video_path && !cover_path) {
      return new Response('No file paths provided.', { status: 400 })
    }

    const pathsToDelete: string[] = []
    if (video_path) pathsToDelete.push(video_path)
    if (cover_path) pathsToDelete.push(cover_path)

    console.log('Files to delete:', pathsToDelete)

    const { error: deleteError } = await supabaseAdmin.storage
      .from('IdeaUploads') // 这里依然用你现在的 Bucket 名
      .remove(pathsToDelete)

    if (deleteError) {
      console.error('Storage deletion failed:', deleteError)
      return new Response(JSON.stringify({ error: deleteError.message }), { status: 500 })
    }

    return new Response('Storage files successfully deleted.', { status: 200 })
  } catch (error) {
    console.error('Handler error:', error)
    return new Response(JSON.stringify({ error: (error as Error).message }), { status: 500 })
  }
})

// supabase/functions/generate-video/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

const VOLCANO_API_BASE =
  Deno.env.get("VOLCANO_API_BASE") ||
  "https://ark.cn-beijing.volces.com/api/v3"
const VOLCANO_API_KEY = Deno.env.get("VOLCANO_API_KEY") || ""

const SUPABASE_URL = Deno.env.get("SUPABASE_URL") || ""
const SERVICE_ROLE_KEY =
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ||
  Deno.env.get("SERVICE_ROLE_KEY") ||
  ""

const BUCKET = Deno.env.get("VITE_SUPABASE_BUCKET") || "IdeaUploads"
const CALLBACK_URL = Deno.env.get("VOLCANO_CALLBACK_URL") || ""
const CALLBACK_SECRET = Deno.env.get("VOLCANO_CALLBACK_SECRET") || ""

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
}

interface GenerateVideoRequest {
  prompt: string
  resolution: "480p" | "720p"
  ratio: "16:9" | "4:3" | "1:1" | "3:4" | "9:16" | "21:9"
  duration: 3 | 4 | 5
  fps?: 16 | 24
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 204, headers: corsHeaders })
  }

  try {
    const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY)

    const { action, ...params } = await req.json()
    console.log("[generate-video] action:", action, "params:", params)

    if (action === "create") {
      const user = await getUserFromRequest(req, supabase)
      return await handleCreateTask(params as GenerateVideoRequest, user.id, supabase)
    } else if (action === "query") {
      const user = await getUserFromRequest(req, supabase)
      const taskId = params.taskId as string
      return await handleQueryTask(taskId, user.id, supabase)
    } else if (action === "download") {
      const user = await getUserFromRequest(req, supabase)
      return await handleDownloadAndPublish(params as any, user.id, supabase)
    } else if (action === "sync_from_ark") {
      const user = await getUserFromRequest(req, supabase)
      const taskId = params.taskId as string
      return await handleSyncFromArk(taskId, user.id, supabase)
    } else {
      throw new Error("Invalid action")
    }
  } catch (error) {
    console.error("[generate-video] Error:", error)
    return new Response(
      JSON.stringify({ error: (error as Error).message }),
      {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      },
    )
  }
})

async function getUserFromRequest(req: Request, supabase: any) {
  const authHeader = req.headers.get("Authorization") || ""
  const token = authHeader.replace("Bearer ", "")

  if (!token) {
    throw new Error("No authorization token")
  }

  const { data, error } = await supabase.auth.getUser(token)
  if (error || !data.user) {
    console.error("[generate-video] getUser error:", error)
    throw new Error("Unauthorized")
  }

  return data.user
}

// 1. 创建任务：带 callback_url + return_last_frame = true + callback_secret
async function handleCreateTask(
  params: GenerateVideoRequest,
  userId: string,
  supabase: any,
): Promise<Response> {
  const { prompt, resolution, ratio, duration, fps = 16 } = params

  if (!VOLCANO_API_KEY) {
    throw new Error("VOLCANO_API_KEY not set")
  }
  if (!CALLBACK_URL) {
    throw new Error("VOLCANO_CALLBACK_URL not set")
  }

  const fullPrompt = `${prompt} --rs ${resolution} --rt ${ratio} --dur ${duration} --fps ${fps}`
  console.log("[generate-video] createTask prompt:", fullPrompt)

  const bodyPayload: Record<string, unknown> = {
    content: [{ text: fullPrompt, type: "text" }],
    model: "doubao-seedance-1-0-pro-fast-251015",
    callback_url: CALLBACK_URL,
    return_last_frame: true,
  }

  if (CALLBACK_SECRET) {
    bodyPayload["callback_secret"] = CALLBACK_SECRET
  }

  const response = await fetch(`${VOLCANO_API_BASE}/contents/generations/tasks`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${VOLCANO_API_KEY}`,
    },
    body: JSON.stringify(bodyPayload),
  })

  if (!response.ok) {
    const errorText = await response.text()
    console.error("[generate-video] createTask non-ok:", response.status, errorText)
    throw new Error(`Failed to create task: ${errorText}`)
  }

  const data = await response.json()
  console.log("[generate-video] createTask response:", data)

  // ★ 这里需要按 Ark 实际返回体调整
  const externalTaskId =
    data?.id ??
    data?.task_id ??
    data?.data?.task_id
  const status: string =
    data?.status ??
    data?.task_status ??
    "queued"

  if (!externalTaskId) {
    throw new Error("Cannot find external task id in AIG response")
  }

  const { error: insertError } = await supabase
    .from("video_generation_tasks")
    .insert({
      user_id: userId,
      external_task_id: externalTaskId,
      status,
      prompt,
      resolution,
      ratio,
      duration,
      fps,
    })

  if (insertError) {
    console.error("[generate-video] insert task error:", insertError)
    throw new Error("Failed to save task to database")
  }

  return new Response(
    JSON.stringify({ externalTaskId, status }),
    { headers: { ...corsHeaders, "Content-Type": "application/json" } },
  )
}

// 2. 查询任务：只查我们自己的任务表
async function handleQueryTask(
  taskId: string,
  userId: string,
  supabase: any,
): Promise<Response> {
  const { data, error } = await supabase
    .from("video_generation_tasks")
    .select("*")
    .eq("external_task_id", taskId)
    .eq("user_id", userId)
    .maybeSingle()

  if (error) {
    console.error("[generate-video] query task error:", error)
    throw new Error("Failed to query task from database")
  }

  if (!data) {
    return new Response(
      JSON.stringify({ error: "Task not found" }),
      {
        status: 404,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      },
    )
  }

  return new Response(
    JSON.stringify(data),
    { headers: { ...corsHeaders, "Content-Type": "application/json" } },
  )
}

// 3. 下载 & 发布：从 Ark 的 video_url / last_frame_url 下载，上传到 Storage，再写入 videos 表
async function handleDownloadAndPublish(
  params: any,
  userId: string,
  supabase: any,
): Promise<Response> {
  const { taskId, title, description, tags, duration, aspect_ratio } = params

  if (!taskId || !title) {
    throw new Error("taskId and title are required")
  }

  const { data: task, error: taskError } = await supabase
    .from("video_generation_tasks")
    .select("*")
    .eq("external_task_id", taskId)
    .eq("user_id", userId)
    .maybeSingle()

  if (taskError) {
    console.error("[generate-video] fetch task error:", taskError)
    throw new Error("Failed to fetch task from database")
  }

  if (!task) {
    throw new Error("Task not found")
  }

  if (task.status !== "succeeded" || !task.video_url) {
    throw new Error("Task not succeeded or video_url missing")
  }

  // 1. 下载视频
  console.log("[generate-video] download video from:", task.video_url)
  const videoResponse = await fetch(task.video_url, { redirect: "follow" })
  if (!videoResponse.ok) {
    const text = await videoResponse.text().catch(() => "")
    console.error("[generate-video] download video non-ok:", videoResponse.status, text)
    throw new Error("Failed to download video")
  }
  const videoArrayBuffer = await videoResponse.arrayBuffer()

  // 2. 下载尾帧（如果有）
  let coverArrayBuffer: ArrayBuffer | null = null
  if (task.last_frame_url) {
    console.log("[generate-video] download last frame from:", task.last_frame_url)
    const coverResponse = await fetch(task.last_frame_url, { redirect: "follow" })
    if (!coverResponse.ok) {
      const text = await coverResponse.text().catch(() => "")
      console.error(
        "[generate-video] download last frame non-ok:",
        coverResponse.status,
        text,
      )
      // 可以忽略封面失败
    } else {
      coverArrayBuffer = await coverResponse.arrayBuffer()
    }
  }

  const videoPath = `${userId}/videos/ai-generated-${taskId}.mp4`
  const coverPath = coverArrayBuffer ? `${userId}/covers/ai-generated-${taskId}.png` : null

  // 3. 上传视频
  const { error: uploadVideoError } = await supabase.storage
    .from(BUCKET)
    .upload(videoPath, videoArrayBuffer, {
      contentType: "video/mp4",
      upsert: false,
    })

  if (uploadVideoError) {
    console.error("[generate-video] upload video error:", uploadVideoError)
    throw new Error(`Failed to upload video: ${uploadVideoError.message}`)
  }

  // 4. 上传封面（如果有）
  if (coverArrayBuffer && coverPath) {
    const { error: uploadCoverError } = await supabase.storage
      .from(BUCKET)
      .upload(coverPath, coverArrayBuffer, {
        contentType: "image/png",
        upsert: false,
      })

    if (uploadCoverError) {
      console.error("[generate-video] upload cover error:", uploadCoverError)
      // 不阻塞主流程
    }
  }

  // 拿 public URL（可选，更多是给前端展示用）
  const { data: videoPublic } = supabase.storage
    .from(BUCKET)
    .getPublicUrl(videoPath)

  const coverPublic = coverPath
    ? supabase.storage.from(BUCKET).getPublicUrl(coverPath).data.publicUrl
    : null

  // 5. 写入 videos 表（注意：video_path / cover_path 存路径，不是完整 URL）
  const { data: inserted, error: insertVideoError } = await supabase
    .from("videos")
    .insert({
      uploader_id: userId,
      title,
      description: description ?? null,
      tags: tags ?? null,
      video_path: videoPath,
      cover_path: coverPath ?? "",
      duration: duration ?? task.duration ?? 0,
      aspect_ratio: aspect_ratio ?? 1.77,
      is_public: true,
      is_deleted: false,
    })
    .select("*")

  if (insertVideoError) {
    console.error("[generate-video] insert video row error:", insertVideoError)
    throw new Error("Failed to create video record")
  }

  // 6. 更新任务状态
  const { error: updateTaskError } = await supabase
    .from("video_generation_tasks")
    .update({ status: "uploaded" })
    .eq("id", task.id)

  if (updateTaskError) {
    console.error("[generate-video] update task status error:", updateTaskError)
  }

  return new Response(
    JSON.stringify({
      taskId,
      video: inserted?.[0],
      videoPublicUrl: videoPublic.publicUrl,
      coverPublicUrl: coverPublic,
    }),
    { headers: { ...corsHeaders, "Content-Type": "application/json" } },
  )
}

// 4. 主动从 Ark 同步任务状态（fallback，用于 callback 异常时）
async function handleSyncFromArk(
  taskId: string,
  userId: string,
  supabase: any,
): Promise<Response> {
  if (!taskId) {
    throw new Error("taskId is required")
  }
  if (!VOLCANO_API_KEY) {
    throw new Error("VOLCANO_API_KEY not set")
  }

  // 1. 确认这条任务属于当前用户
  const { data: task, error: fetchError } = await supabase
    .from("video_generation_tasks")
    .select("*")
    .eq("external_task_id", taskId)
    .eq("user_id", userId)
    .maybeSingle()

  if (fetchError) {
    console.error("[generate-video] sync_from_ark: fetch task error:", fetchError)
    throw new Error("Failed to fetch task from database")
  }
  if (!task) {
    return new Response(
      JSON.stringify({ error: "Task not found" }),
      { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } },
    )
  }

  // 2. 请求 Ark 查询任务状态
  const arkResp = await fetch(
    `${VOLCANO_API_BASE}/contents/generations/tasks/${encodeURIComponent(taskId)}`,
    {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${VOLCANO_API_KEY}`,
      },
    },
  )

  if (!arkResp.ok) {
    const text = await arkResp.text().catch(() => "")
    console.error("[generate-video] sync_from_ark: Ark non-ok:", arkResp.status, text)
    throw new Error(`Failed to query task from Ark: ${text}`)
  }

  const arkData = await arkResp.json()
  console.log("[generate-video] sync_from_ark arkData:", arkData)

  // Ark 返回体结构：
  // {
  //   id: string,
  //   model: string,
  //   status: "queued" | "running" | "succeeded" | "failed" | ...,
  //   content: {
  //     video_url: string,
  //     last_frame_url?: string
  //   },
  //   ...
  // }

  const status: string =
    typeof arkData?.status === "string" ? arkData.status : task.status

  const content = arkData?.content ?? {}
  const videoUrl =
    typeof content?.video_url === "string" ? content.video_url : task.video_url
  const lastFrameUrl =
    typeof content?.last_frame_url === "string"
      ? content.last_frame_url
      : task.last_frame_url

  const errorObj = arkData?.error ?? null
  const errorMessage =
    status === "failed" && errorObj != null
      ? JSON.stringify(errorObj)
      : task.error_message

  // 3. 写回本地数据库
  const { data: updated, error: updateError } = await supabase
    .from("video_generation_tasks")
    .update({
      status,
      video_url: videoUrl,
      last_frame_url: lastFrameUrl,
      error_message: errorMessage,
    })
    .eq("id", task.id)
    .select("*")
    .maybeSingle()

  if (updateError) {
    console.error("[generate-video] sync_from_ark: update task error:", updateError)
    throw new Error("Failed to update task in database")
  }

  return new Response(
    JSON.stringify(updated),
    { headers: { ...corsHeaders, "Content-Type": "application/json" } },
  )
}

// supabase/functions/video-callback/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

const SUPABASE_URL = Deno.env.get("SUPABASE_URL") || ""
const SERVICE_ROLE_KEY =
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ||
  Deno.env.get("SERVICE_ROLE_KEY") ||
  ""

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 204, headers: corsHeaders })
  }

  if (req.method !== "POST") {
    return new Response("Method not allowed", {
      status: 405,
      headers: corsHeaders,
    })
  }

  try {
    const payload = await req.json()
    console.log("[video-callback] payload:", JSON.stringify(payload))

    // Ark 回调体结构 = 查询返回体
    // 必有字段：id, status, content, error?, created_at, updated_at, ...
    const externalTaskId = payload?.id
    if (!externalTaskId || typeof externalTaskId !== "string") {
      console.error("[video-callback] missing id in payload")
      return new Response("Bad payload: missing id", {
        status: 400,
        headers: corsHeaders,
      })
    }

    const status: string =
      typeof payload?.status === "string" ? payload.status : "unknown"

    const content = payload?.content ?? {}
    const videoUrl =
      typeof content?.video_url === "string" ? content.video_url : null
    const lastFrameUrl =
      typeof content?.last_frame_url === "string" ? content.last_frame_url : null

    const errorObj = payload?.error ?? null
    const errorMessage =
      status === "failed" && errorObj != null
        ? JSON.stringify(errorObj)
        : null

    const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY)

    const { data, error } = await supabase
      .from("video_generation_tasks")
      .update({
        status,
        video_url: videoUrl,
        last_frame_url: lastFrameUrl,
        error_message: errorMessage,
      })
      .eq("external_task_id", externalTaskId)
      .select("id")
      .maybeSingle()

    if (error) {
      console.error("[video-callback] update task error:", error)
      return new Response("Failed to update task", {
        status: 500,
        headers: corsHeaders,
      })
    }

    if (!data) {
      console.warn(
        "[video-callback] no task row matched external_task_id:",
        externalTaskId,
      )
      // 返回 200，让 Ark 不要一直重试，但我们自己记录日志
    }

    return new Response(
      JSON.stringify({ ok: true }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } },
    )
  } catch (err) {
    console.error("[video-callback] Error:", err)
    return new Response(
      JSON.stringify({ error: (err as Error).message }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } },
    )
  }
})
